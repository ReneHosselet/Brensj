import{ExtensionProperty as e,PropertyType as t,COPY_IDENTITY as s,GraphChildList as r,Extension as o,BufferUtils as n,WriterContext as i,Primitive as a,AnimationSampler as c,AnimationChannel as u,Accessor as h,GLB_BUFFER as l,ImageUtils as p,bounds as f,ColorUtils as x,MathUtils as d,TextureInfo as T,GraphChild as g,TextureChannel as m}from"@gltf-transform/core";import{read as _,KTX2Model as E}from"ktx-parse";function C(e,t,s,r){var o,n=arguments.length,i=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,s,r);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(i=(n<3?o(i):n>3?o(t,s,i):o(t,s))||i);return n>3&&i&&Object.defineProperty(t,s,i),i}class I extends e{constructor(...e){super(...e),this.propertyType="InstancedMesh",this.parentTypes=[t.NODE],this.extensionName="EXT_mesh_gpu_instancing",this.attributes=[]}copy(e,t=s){return super.copy(e,t),this.clearGraphChildList(this.attributes),e.listSemantics().forEach(s=>{this.setAttribute(s,t(e.getAttribute(s)))}),this}getAttribute(e){const t=this.attributes.find(t=>t.semantic===e);return t?t.getChild():null}setAttribute(e,t){const s=this.getAttribute(e);if(s&&this.removeGraphChild(this.attributes,s),!t)return this;const r=this.graph.linkAttribute(e.toLowerCase(),this,t);return r.semantic=e,this.addGraphChild(this.attributes,r)}listAttributes(){return this.attributes.map(e=>e.getChild())}listSemantics(){return this.attributes.map(e=>e.semantic)}}I.EXTENSION_NAME="EXT_mesh_gpu_instancing",C([r],I.prototype,"attributes",void 0);const N="EXT_mesh_gpu_instancing";class y extends o{constructor(...e){super(...e),this.extensionName=N,this.provideTypes=[t.NODE],this.prewriteTypes=[t.ACCESSOR]}createInstancedMesh(){return new I(this.doc.getGraph(),this)}read(e){return(e.jsonDoc.json.nodes||[]).forEach((t,s)=>{if(!t.extensions||!t.extensions[N])return;const r=t.extensions[N],o=this.createInstancedMesh();for(const t in r.attributes)o.setAttribute(t,e.accessors[r.attributes[t]]);e.nodes[s].setExtension(N,o)}),this}prewrite(e){e.accessorUsageGroupedByParent.add("INSTANCE_ATTRIBUTE");for(const t of this.properties)for(const s of t.listAttributes())e.addAccessorToUsageGroup(s,"INSTANCE_ATTRIBUTE");return this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listNodes().forEach(s=>{const r=s.getExtension(N);if(r){const o=e.nodeIndexMap.get(s),n=t.json.nodes[o],i={attributes:{}};r.listSemantics().forEach(t=>{const s=r.getAttribute(t);i.attributes[t]=e.accessorIndexMap.get(s)}),n.extensions=n.extensions||{},n.extensions[N]=i}}),this}}function R(){return(R=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])}return e}).apply(this,arguments)}var A,S,F;function w(e,t,s,r){let o=e.getArray(),i=o.byteLength/e.getCount();return s===S.ATTRIBUTES&&r!==F.NONE?r===F.EXPONENTIAL?(i=4*e.getElementSize(),o=t.encodeFilterExp(new Float32Array(o),e.getCount(),i,12)):r===F.OCTAHEDRAL?(i=8,o=t.encodeFilterOct(new Float32Array(o),e.getCount(),i,8)):r===F.QUATERNION&&(i=8,o=t.encodeFilterQuat(new Float32Array(o),e.getCount(),i,16)):s===S.ATTRIBUTES&&i%4&&(o=function(e,t){const s=n.padNumber(e.BYTES_PER_ELEMENT*t)/e.BYTES_PER_ELEMENT,r=new e.constructor(e.length/t*s);for(let o=0;o*t<e.length;o++)for(let n=0;n<t;n++)r[o*s+n]=e[o*t+n];return r}(o,e.getElementSize()),i=o.byteLength/e.getCount()),{array:o,byteStride:i}}function M(e,t){return t===i.BufferViewUsage.ELEMENT_ARRAY_BUFFER?e.listParents().some(e=>e instanceof a&&e.getMode()===a.Mode.TRIANGLES)?S.TRIANGLES:S.INDICES:S.ATTRIBUTES}function O(e,t){const s=t.getGraph().listParentLinks(e).map(e=>e.getName()).filter(e=>"accessor"!==e);for(const t of s){if("NORMAL"===t)return F.NONE;if("TANGENT"===t)return F.OCTAHEDRAL;if(t.startsWith("JOINTS_"))return F.NONE;if(t.startsWith("WEIGHTS_"))return F.NONE;if("output"===t){const t=D(e);return"rotation"===t?F.NONE:"translation"===t||"scale"===t?F.EXPONENTIAL:F.NONE}if("input"===t)return F.NONE;if("inverseBindMatrices"===t)return F.NONE}return F.EXPONENTIAL}function D(e){for(const t of e.listParents())if(t instanceof c)for(const e of t.listParents())if(e instanceof u)return e.getTargetPath();return null}y.EXTENSION_NAME=N,function(e){e.QUANTIZE="quantize",e.FILTER="filter"}(A||(A={})),function(e){e.ATTRIBUTES="ATTRIBUTES",e.TRIANGLES="TRIANGLES",e.INDICES="INDICES"}(S||(S={})),function(e){e.NONE="NONE",e.OCTAHEDRAL="OCTAHEDRAL",e.QUATERNION="QUATERNION",e.EXPONENTIAL="EXPONENTIAL"}(F||(F={}));const b="EXT_meshopt_compression",v={method:A.QUANTIZE};class G extends o{constructor(...e){super(...e),this.extensionName=b,this.prereadTypes=[t.BUFFER,t.PRIMITIVE],this.prewriteTypes=[t.BUFFER,t.ACCESSOR],this.readDependencies=["meshopt.decoder"],this.writeDependencies=["meshopt.encoder"],this._decoder=null,this._decoderFallbackBufferMap=new Map,this._encoder=null,this._encoderOptions=v,this._encoderFallbackBuffer=null,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={}}install(e,t){return"meshopt.decoder"===e&&(this._decoder=t),"meshopt.encoder"===e&&(this._encoder=t),this}setEncoderOptions(e){return this._encoderOptions=R({},v,e),this}preread(e,s){if(!this._decoder){if(!this.isRequired())return this;throw new Error(`[${b}] Please install extension dependency, "meshopt.decoder".`)}if(!this._decoder.supported){if(!this.isRequired())return this;throw new Error(`[${b}]: Missing WASM support.`)}return s===t.BUFFER?this._prereadBuffers(e):s===t.PRIMITIVE&&this._prereadPrimitives(e),this}_prereadBuffers(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach((s,r)=>{if(!s.extensions||!s.extensions[b])return;const o=s.extensions[b],n=o.byteOffset||0,i=o.byteLength||0,a=o.count,c=o.byteStride,u=new Uint8Array(new ArrayBuffer(a*c)),h=t.json.buffers[s.buffer],p=new Uint8Array(h.uri?t.resources[h.uri]:t.resources[l],n,i);this._decoder.decodeGltfBuffer(u,a,c,p,o.mode,o.filter),e.bufferViews[r]=u})}_prereadPrimitives(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach(s=>{var r;s.extensions&&s.extensions[b]&&(r=t.json.buffers[s.buffer]).extensions&&r.extensions.EXT_meshopt_compression&&r.extensions.EXT_meshopt_compression.fallback&&this._decoderFallbackBufferMap.set(e.buffers[s.buffer],e.buffers[s.extensions[b].buffer])})}read(e){if(!this.isRequired())return this;for(const[e,t]of this._decoderFallbackBufferMap){for(const s of e.listParents())s instanceof h&&s.swap(e,t);e.dispose()}return this}prewrite(e,s){return s===t.ACCESSOR?this._prewriteAccessors(e):s===t.BUFFER&&this._prewriteBuffers(e),this}_prewriteAccessors(e){const t=e.jsonDoc.json,s=this._encoder,r=this._encoderOptions,o=this.doc.createBuffer(),n=this.doc.getRoot().listBuffers().indexOf(o);this._encoderFallbackBuffer=o,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={};for(const o of this.doc.getRoot().listAccessors()){const a=e.getAccessorUsage(o),c=M(o,a),u=r.method===A.FILTER?O(o,this.doc):F.NONE,{array:h,byteStride:l}=w(o,s,c,u);if("weights"===D(o))continue;const p=o.getBuffer();if(!p)throw new Error(`${b}: Missing buffer for accessor.`);const f=this.doc.getRoot().listBuffers().indexOf(p),x=[a,c,u,l,f].join(":");let d=this._encoderBufferViews[x],T=this._encoderBufferViewData[x],g=this._encoderBufferViewAccessors[x];d&&T||(g=this._encoderBufferViewAccessors[x]=[],T=this._encoderBufferViewData[x]=[],d=this._encoderBufferViews[x]={buffer:n,target:i.USAGE_TO_TARGET[a],byteOffset:0,byteLength:0,byteStride:a===i.BufferViewUsage.ARRAY_BUFFER?l:void 0,extensions:{[b]:{buffer:f,byteOffset:0,byteLength:0,mode:c,filter:u===F.NONE?void 0:u,byteStride:l,count:0}}});const m=e.createAccessorDef(o);m.byteOffset=d.byteLength,e.accessorIndexMap.set(o,t.accessors.length),t.accessors.push(m),g.push(m),T.push(h.slice().buffer),d.byteLength+=h.byteLength,d.extensions.EXT_meshopt_compression.count+=o.getCount()}}_prewriteBuffers(e){const t=this._encoder;for(const s in this._encoderBufferViews){const r=this._encoderBufferViews[s],o=this._encoderBufferViewData[s],i=this.doc.getRoot().listBuffers()[r.extensions[b].buffer],a=e.otherBufferViews.get(i)||[],{count:c,byteStride:u,mode:h}=r.extensions[b],l=new Uint8Array(n.concat(o)),p=t.encodeGltfBuffer(l,c,u,h),f=n.pad(p.slice().buffer);r.extensions[b].byteLength=p.byteLength,o.length=0,o.push(f),a.push(f),e.otherBufferViews.set(i,a)}}write(e){let t=0;for(const s in this._encoderBufferViews){const r=this._encoderBufferViews[s],o=e.otherBufferViewsIndexMap.get(this._encoderBufferViewData[s][0]),i=this._encoderBufferViewAccessors[s];for(const e of i)e.bufferView=o;const a=e.jsonDoc.json.bufferViews[o],c=a.byteOffset||0;Object.assign(a,r),a.byteOffset=t,a.extensions[b].byteOffset=c,t+=n.padNumber(r.byteLength)}const s=this._encoderFallbackBuffer,r=e.bufferIndexMap.get(s),o=e.jsonDoc.json.buffers[r];return o.byteLength=t,o.extensions={[b]:{fallback:!0}},s.dispose(),this}}G.EXTENSION_NAME=b,G.EncoderMethod=A;const j="EXT_texture_webp";class B{getSize(e){const t=n.decodeText(e.slice(0,4)),s=n.decodeText(e.slice(8,12));if("RIFF"!==t||"WEBP"!==s)return null;const r=new DataView(e);let o=12;for(;o<e.byteLength;){const t=n.decodeText(e.slice(o,o+4)),s=r.getUint32(o+4,!0);if("VP8 "===t)return[16383&r.getInt16(o+14,!0),16383&r.getInt16(o+16,!0)];if("VP8L"===t){const e=r.getUint8(o+9),t=r.getUint8(o+10),s=r.getUint8(o+11);return[1+((63&t)<<8|e),1+((15&r.getUint8(o+12))<<10|s<<2|(192&t)>>6)]}o+=8+s+s%2}return null}getChannels(e){return 4}}class L extends o{constructor(...e){super(...e),this.extensionName=j,this.prereadTypes=[t.TEXTURE]}static register(){p.registerFormat("image/webp",new B)}preread(e){return(e.jsonDoc.json.textures||[]).forEach(e=>{e.extensions&&e.extensions[j]&&(e.source=e.extensions[j].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listTextures().forEach(s=>{if("image/webp"===s.getMimeType()){const r=e.imageIndexMap.get(s);(t.json.textures||[]).forEach(e=>{e.source===r&&(e.extensions=e.extensions||{},e.extensions[j]={source:e.source},delete e.source)})}}),this}}L.EXTENSION_NAME=j;const k="KHR_draco_mesh_compression";let U,H,V,P;function X(e,t){const s=new U.DecoderBuffer;try{if(s.Init(t,t.length),e.GetEncodedGeometryType(s)!==U.TRIANGULAR_MESH)throw new Error(`[${k}] Unknown geometry type.`);const r=new U.Mesh;if(!e.DecodeBufferToMesh(s,r).ok()||0===r.ptr)throw new Error(`[${k}] Decoding failure.`);return r}finally{U.destroy(s)}}function K(e,t){const s=3*t.num_faces();let r,o;if(t.num_points()<=65534){const n=s*Uint16Array.BYTES_PER_ELEMENT;r=U._malloc(n),e.GetTrianglesUInt16Array(t,n,r),o=new Uint16Array(U.HEAPU16.buffer,r,s).slice()}else{const n=s*Uint32Array.BYTES_PER_ELEMENT;r=U._malloc(n),e.GetTrianglesUInt32Array(t,n,r),o=new Uint32Array(U.HEAPU32.buffer,r,s).slice()}return U._free(r),o}function z(e,t,s,r){const o=V[r.componentType],n=H[r.componentType],i=s.num_components(),a=t.num_points()*i,c=a*n.BYTES_PER_ELEMENT,u=U._malloc(c);e.GetAttributeDataArrayForAllPoints(t,s,o,c,u);const h=new n(U.HEAPF32.buffer,u,a).slice();return U._free(u),h}var q,$;!function(e){e[e.EDGEBREAKER=1]="EDGEBREAKER",e[e.SEQUENTIAL=0]="SEQUENTIAL"}(q||(q={})),function(e){e.POSITION="POSITION",e.NORMAL="NORMAL",e.COLOR="COLOR",e.TEX_COORD="TEX_COORD",e.GENERIC="GENERIC"}($||($={}));const Y={[$.POSITION]:14,[$.NORMAL]:10,[$.COLOR]:8,[$.TEX_COORD]:12,[$.GENERIC]:12},Q={decodeSpeed:5,encodeSpeed:5,method:q.EDGEBREAKER,quantizationBits:Y,quantizationVolume:"mesh"};function W(e,t=Q){const s=R({},Q,t);s.quantizationBits=R({},Y,t.quantizationBits);const r=new P.Encoder,o=new P.MeshBuilder,n=new P.Mesh,i={},a=new P.DracoInt8Array;for(const t of e.listSemantics()){const a=e.getAttribute(t),c=J(t),u=Z(o,a.getComponentType(),n,P[c],a.getCount(),a.getElementSize(),a.getArray());if(-1===u)throw new Error(`Error compressing "${t}" attribute.`);if(i[t]=u,"mesh"===s.quantizationVolume||"POSITION"!==t)r.SetAttributeQuantization(P[c],s.quantizationBits[c]);else{if("object"!=typeof s.quantizationVolume)throw new Error("Invalid quantization volume state.");{const{quantizationVolume:e}=s,t=Math.max(e.max[0]-e.min[0],e.max[1]-e.min[1],e.max[2]-e.min[2]);r.SetAttributeExplicitQuantization(P[c],s.quantizationBits[c],a.getElementSize(),e.min,t)}}}const c=e.getIndices();if(!c)throw new Error("Primitive must have indices.");o.AddFacesToMesh(n,c.getCount()/3,c.getArray()),r.SetSpeedOptions(s.encodeSpeed,s.decodeSpeed),r.SetTrackEncodedProperties(!0),e.listTargets().length>0||s.method===q.SEQUENTIAL?r.SetEncodingMethod(P.MESH_SEQUENTIAL_ENCODING):r.SetEncodingMethod(P.MESH_EDGEBREAKER_ENCODING);const u=r.EncodeMeshToDracoBuffer(n,a);if(u<=0)throw new Error("Error applying Draco compression.");const h=new Uint8Array(u);for(let e=0;e<u;++e)h[e]=a.GetValue(e);const l=r.GetNumberOfEncodedPoints(),p=3*r.GetNumberOfEncodedFaces();return P.destroy(a),P.destroy(n),P.destroy(o),P.destroy(r),{numVertices:l,numIndices:p,data:h,attributeIDs:i}}function J(e){return"POSITION"===e?$.POSITION:"NORMAL"===e?$.NORMAL:e.startsWith("COLOR_")?$.COLOR:e.startsWith("TEXCOORD_")?$.TEX_COORD:$.GENERIC}function Z(e,t,s,r,o,n,i){switch(t){case h.ComponentType.UNSIGNED_BYTE:return e.AddUInt8Attribute(s,r,o,n,i);case h.ComponentType.BYTE:return e.AddInt8Attribute(s,r,o,n,i);case h.ComponentType.UNSIGNED_SHORT:return e.AddUInt16Attribute(s,r,o,n,i);case h.ComponentType.SHORT:return e.AddInt16Attribute(s,r,o,n,i);case h.ComponentType.UNSIGNED_INT:return e.AddUInt32Attribute(s,r,o,n,i);case h.ComponentType.FLOAT:return e.AddFloatAttribute(s,r,o,n,i);default:throw new Error(`Unexpected component type, "${t}".`)}}const ee="KHR_draco_mesh_compression";class te extends o{constructor(...e){super(...e),this.extensionName=ee,this.prereadTypes=[t.PRIMITIVE],this.prewriteTypes=[t.ACCESSOR],this.readDependencies=["draco3d.decoder"],this.writeDependencies=["draco3d.encoder"],this._decoderModule=null,this._encoderModule=null,this._encoderOptions={}}install(e,t){return"draco3d.decoder"===e&&(this._decoderModule=t,U=this._decoderModule,H={[h.ComponentType.FLOAT]:Float32Array,[h.ComponentType.UNSIGNED_INT]:Uint32Array,[h.ComponentType.UNSIGNED_SHORT]:Uint16Array,[h.ComponentType.UNSIGNED_BYTE]:Uint8Array,[h.ComponentType.SHORT]:Int16Array,[h.ComponentType.BYTE]:Int8Array},V={[h.ComponentType.FLOAT]:U.DT_FLOAT32,[h.ComponentType.UNSIGNED_INT]:U.DT_UINT32,[h.ComponentType.UNSIGNED_SHORT]:U.DT_UINT16,[h.ComponentType.UNSIGNED_BYTE]:U.DT_UINT8,[h.ComponentType.SHORT]:U.DT_INT16,[h.ComponentType.BYTE]:U.DT_INT8}),"draco3d.encoder"===e&&(this._encoderModule=t,P=this._encoderModule),this}setEncoderOptions(e){return this._encoderOptions=e,this}preread(e){if(!this._decoderModule)throw new Error(`[${ee}] Please install extension dependency, "draco3d.decoder".`);const t=this.doc.getLogger(),s=e.jsonDoc,r=new Map;try{const o=s.json.meshes||[];for(const n of o)for(const o of n.primitives){if(!o.extensions||!o.extensions[ee])continue;const n=o.extensions[ee];let[i,a]=r.get(n.bufferView)||[];if(!a||!i){const e=s.json.bufferViews[n.bufferView],o=s.json.buffers[e.buffer],c=new Int8Array(o.uri?s.resources[o.uri]:s.resources[l],e.byteOffset||0,e.byteLength);i=new this._decoderModule.Decoder,a=X(i,c),r.set(n.bufferView,[i,a]),t.debug(`[${ee}] Decompressed ${c.byteLength} bytes.`)}for(const t in o.attributes){const s=e.jsonDoc.json.accessors[o.attributes[t]],r=i.GetAttributeByUniqueId(a,n.attributes[t]),c=z(i,a,r,s);e.accessors[o.attributes[t]].setArray(c)}void 0!==o.indices&&e.accessors[o.indices].setArray(K(i,a))}}finally{for(const[e,t]of Array.from(r.values()))this._decoderModule.destroy(e),this._decoderModule.destroy(t)}return this}read(e){return this}prewrite(e,t){if(!this._encoderModule)throw new Error(`[${ee}] Please install extension dependency, "draco3d.encoder".`);const s=this.doc.getLogger();s.debug(`[${ee}] Compression options: ${JSON.stringify(this._encoderOptions)}`);const r=function(e){const t=e.getLogger(),s=new Set,r=new Set;for(const o of e.getRoot().listMeshes())for(const e of o.listPrimitives())e.getIndices()?e.getMode()!==a.Mode.TRIANGLES?(r.add(e),t.warn(`[${ee}] Skipping Draco compression on non-TRIANGLES primitive.`)):s.add(e):(r.add(e),t.warn(`[${ee}] Skipping Draco compression on non-indexed primitive.`));const o=e.getRoot().listAccessors(),n=new Map;for(let e=0;e<o.length;e++)n.set(o[e],e);const i=new Map,c=new Set,u=new Map;for(const t of Array.from(s)){let s=se(t,n);if(c.has(s))u.set(t,s);else{if(i.has(t.getIndices())){const s=t.getIndices(),r=s.clone();n.set(r,e.getRoot().listAccessors().length-1),t.swap(s,r)}for(const s of t.listAttributes())if(i.has(s)){const r=s.clone();n.set(r,e.getRoot().listAccessors().length-1),t.swap(s,r)}s=se(t,n),c.add(s),u.set(t,s),i.set(t.getIndices(),s);for(const e of t.listAttributes())i.set(e,s)}}for(const e of Array.from(i.keys())){const t=new Set(e.listParents().map(e=>e.propertyType));if(2!==t.size||!t.has("Primitive")||!t.has("Root"))throw new Error(`[${ee}] Compressed accessors must only be used as indices or vertex attributes.`)}for(const e of Array.from(s)){const t=u.get(e),s=e.getIndices();if(i.get(s)!==t||e.listAttributes().some(e=>i.get(e)!==t))throw new Error(`[${ee}] Draco primitives must share all, or no, accessors.`)}for(const e of Array.from(r)){const t=e.getIndices();if(i.has(t)||e.listAttributes().some(e=>i.has(e)))throw new Error(`[${ee}] Accessor cannot be shared by compressed and uncompressed primitives.`)}return u}(this.doc),o=new Map;let n="mesh";"scene"===this._encoderOptions.quantizationVolume&&(1!==this.doc.getRoot().listScenes().length?s.warn(`[${ee}]: quantizationVolume=scene requires exactly 1 scene.`):n=f(this.doc.getRoot().listScenes().pop()));for(const t of Array.from(r.keys())){const s=r.get(t);if(!s)throw new Error("Unexpected primitive.");if(o.has(s)){o.set(s,o.get(s));continue}const i=t.getIndices(),a=e.jsonDoc.json.accessors,c=W(t,R({},this._encoderOptions,{quantizationVolume:n}));o.set(s,c);const u=e.createAccessorDef(i);u.count=c.numIndices,e.accessorIndexMap.set(i,a.length),a.push(u);for(const s of t.listSemantics()){const r=t.getAttribute(s),o=e.createAccessorDef(r);o.count=c.numVertices,e.accessorIndexMap.set(r,a.length),a.push(o)}const h=t.getAttribute("POSITION").getBuffer()||this.doc.getRoot().listBuffers()[0];e.otherBufferViews.has(h)||e.otherBufferViews.set(h,[]),e.otherBufferViews.get(h).push(c.data)}return s.debug(`[${ee}] Compressed ${r.size} primitives.`),e.extensionData[ee]={primitiveHashMap:r,primitiveEncodingMap:o},this}write(e){const t=e.extensionData[ee];for(const s of this.doc.getRoot().listMeshes()){const r=e.jsonDoc.json.meshes[e.meshIndexMap.get(s)];for(let o=0;o<s.listPrimitives().length;o++){const n=s.listPrimitives()[o],i=r.primitives[o],a=t.primitiveHashMap.get(n);if(!a)continue;const c=t.primitiveEncodingMap.get(a);i.extensions=i.extensions||{},i.extensions[ee]={bufferView:e.otherBufferViewsIndexMap.get(c.data),attributes:c.attributeIDs}}}if(!t.primitiveHashMap.size){const t=e.jsonDoc.json;t.extensionsUsed=(t.extensionsUsed||[]).filter(e=>e!==ee),t.extensionsRequired=(t.extensionsRequired||[]).filter(e=>e!==ee)}return this}}function se(e,t){const s=[],r=e.getIndices();s.push(t.get(r));for(const r of e.listAttributes())s.push(t.get(r));return s.sort().join("|")}te.EXTENSION_NAME=ee,te.EncoderMethod=q;class re extends e{constructor(...e){super(...e),this.propertyType="Light",this.parentTypes=[t.NODE],this.extensionName="KHR_lights_punctual",this._color=[1,1,1],this._intensity=1,this._type=re.Type.POINT,this._range=null,this._innerConeAngle=0,this._outerConeAngle=Math.PI/4}copy(e,t=s){return super.copy(e,t),this._color=[...e._color],this._intensity=e._intensity,this._type=e._type,this._range=e._range,this._innerConeAngle=e._innerConeAngle,this._outerConeAngle=e._outerConeAngle,this}getColor(){return this._color}setColor(e){return this._color=e,this}getColorHex(){return x.factorToHex(this._color)}setColorHex(e){return x.hexToFactor(e,this._color),this}getIntensity(){return this._intensity}setIntensity(e){return this._intensity=e,this}getType(){return this._type}setType(e){return this._type=e,this}getRange(){return this._range}setRange(e){return this._range=e,this}getInnerConeAngle(){return this._innerConeAngle}setInnerConeAngle(e){return this._innerConeAngle=e,this}getOuterConeAngle(){return this._outerConeAngle}setOuterConeAngle(e){return this._outerConeAngle=e,this}}re.EXTENSION_NAME="KHR_lights_punctual",re.Type={POINT:"point",SPOT:"spot",DIRECTIONAL:"directional"};const oe="KHR_lights_punctual";class ne extends o{constructor(...e){super(...e),this.extensionName=oe}createLight(){return new re(this.doc.getGraph(),this)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[oe])return this;const s=(t.json.extensions[oe].lights||[]).map(e=>{const t=this.createLight().setName(e.name||"").setType(e.type);return void 0!==e.color&&t.setColor(e.color),void 0!==e.intensity&&t.setIntensity(e.intensity),void 0!==e.range&&t.setRange(e.range),void 0!==e.innerConeAngle&&t.setInnerConeAngle(e.innerConeAngle),void 0!==e.outerConeAngle&&t.setOuterConeAngle(e.outerConeAngle),t});return t.json.nodes.forEach((t,r)=>{t.extensions&&t.extensions[oe]&&e.nodes[r].setExtension(oe,s[t.extensions[oe].light])}),this}write(e){const t=e.jsonDoc;if(0===this.properties.size)return this;const s=[],r=new Map;for(const e of this.properties){const t=e,o={type:t.getType()};d.eq(t.getColor(),[1,1,1])||(o.color=t.getColor()),1!==t.getIntensity()&&(o.intensity=t.getIntensity()),null!=t.getRange()&&(o.range=t.getRange()),t.getName()&&(o.name=t.getName()),t.getType()===re.Type.SPOT&&(o.innerConeAngle=t.getInnerConeAngle(),o.outerConeAngle=t.getOuterConeAngle()),s.push(o),r.set(t,s.length-1)}return this.doc.getRoot().listNodes().forEach(s=>{const o=s.getExtension(oe);if(o){const n=e.nodeIndexMap.get(s),i=t.json.nodes[n];i.extensions=i.extensions||{},i.extensions[oe]={light:r.get(o)}}}),t.json.extensions=t.json.extensions||{},t.json.extensions[oe]={lights:s},this}}ne.EXTENSION_NAME=oe;const{R:ie,G:ae,B:ce}=m;class ue extends e{constructor(...e){super(...e),this.propertyType="Clearcoat",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_clearcoat",this._clearcoatFactor=0,this._clearcoatRoughnessFactor=0,this._clearcoatNormalScale=1,this.clearcoatTexture=null,this.clearcoatTextureInfo=this.graph.link("clearcoatTextureInfo",this,new T(this.graph)),this.clearcoatRoughnessTexture=null,this.clearcoatRoughnessTextureInfo=this.graph.link("clearcoatRoughnessTextureInfo",this,new T(this.graph)),this.clearcoatNormalTexture=null,this.clearcoatNormalTextureInfo=this.graph.link("clearcoatNormalTextureInfo",this,new T(this.graph))}copy(e,t=s){return super.copy(e,t),this._clearcoatFactor=e._clearcoatFactor,this._clearcoatRoughnessFactor=e._clearcoatRoughnessFactor,this._clearcoatNormalScale=e._clearcoatNormalScale,this.setClearcoatTexture(e.clearcoatTexture?t(e.clearcoatTexture.getChild()):null),this.clearcoatTextureInfo.getChild().copy(t(e.clearcoatTextureInfo.getChild()),t),this.setClearcoatRoughnessTexture(e.clearcoatRoughnessTexture?t(e.clearcoatRoughnessTexture.getChild()):null),this.clearcoatRoughnessTextureInfo.getChild().copy(t(e.clearcoatRoughnessTextureInfo.getChild()),t),this.setClearcoatNormalTexture(e.clearcoatNormalTexture?t(e.clearcoatNormalTexture.getChild()):null),this.clearcoatNormalTextureInfo.getChild().copy(t(e.clearcoatNormalTextureInfo.getChild()),t),this}dispose(){this.clearcoatTextureInfo.getChild().dispose(),this.clearcoatRoughnessTextureInfo.getChild().dispose(),this.clearcoatNormalTextureInfo.getChild().dispose(),super.dispose()}getClearcoatFactor(){return this._clearcoatFactor}setClearcoatFactor(e){return this._clearcoatFactor=e,this}getClearcoatTexture(){return this.clearcoatTexture?this.clearcoatTexture.getChild():null}getClearcoatTextureInfo(){return this.clearcoatTexture?this.clearcoatTextureInfo.getChild():null}setClearcoatTexture(e){return this.clearcoatTexture=this.graph.linkTexture("clearcoatTexture",ie,this,e),this}getClearcoatRoughnessFactor(){return this._clearcoatRoughnessFactor}setClearcoatRoughnessFactor(e){return this._clearcoatRoughnessFactor=e,this}getClearcoatRoughnessTexture(){return this.clearcoatRoughnessTexture?this.clearcoatRoughnessTexture.getChild():null}getClearcoatRoughnessTextureInfo(){return this.clearcoatRoughnessTexture?this.clearcoatRoughnessTextureInfo.getChild():null}setClearcoatRoughnessTexture(e){return this.clearcoatRoughnessTexture=this.graph.linkTexture("clearcoatRoughnessTexture",ae,this,e),this}getClearcoatNormalScale(){return this._clearcoatNormalScale}setClearcoatNormalScale(e){return this._clearcoatNormalScale=e,this}getClearcoatNormalTexture(){return this.clearcoatNormalTexture?this.clearcoatNormalTexture.getChild():null}getClearcoatNormalTextureInfo(){return this.clearcoatNormalTexture?this.clearcoatNormalTextureInfo.getChild():null}setClearcoatNormalTexture(e){return this.clearcoatNormalTexture=this.graph.linkTexture("clearcoatNormalTexture",ie|ae|ce,this,e),this}}ue.EXTENSION_NAME="KHR_materials_clearcoat",C([g],ue.prototype,"clearcoatTexture",void 0),C([g],ue.prototype,"clearcoatTextureInfo",void 0),C([g],ue.prototype,"clearcoatRoughnessTexture",void 0),C([g],ue.prototype,"clearcoatRoughnessTextureInfo",void 0),C([g],ue.prototype,"clearcoatNormalTexture",void 0),C([g],ue.prototype,"clearcoatNormalTextureInfo",void 0);const he="KHR_materials_clearcoat";class le extends o{constructor(...e){super(...e),this.extensionName=he}createClearcoat(){return new ue(this.doc.getGraph(),this)}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((t,r)=>{if(t.extensions&&t.extensions[he]){const o=this.createClearcoat();e.materials[r].setExtension(he,o);const n=t.extensions[he];if(void 0!==n.clearcoatFactor&&o.setClearcoatFactor(n.clearcoatFactor),void 0!==n.clearcoatRoughnessFactor&&o.setClearcoatRoughnessFactor(n.clearcoatRoughnessFactor),void 0!==n.clearcoatTexture){const t=n.clearcoatTexture;o.setClearcoatTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getClearcoatTextureInfo(),t)}if(void 0!==n.clearcoatRoughnessTexture){const t=n.clearcoatRoughnessTexture;o.setClearcoatRoughnessTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getClearcoatRoughnessTextureInfo(),t)}if(void 0!==n.clearcoatNormalTexture){const t=n.clearcoatNormalTexture;o.setClearcoatNormalTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getClearcoatNormalTextureInfo(),t),void 0!==t.scale&&o.setClearcoatNormalScale(t.scale)}}}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(he);if(r){const o=e.materialIndexMap.get(s),n=t.json.materials[o];n.extensions=n.extensions||{};const i=n.extensions[he]={clearcoatFactor:r.getClearcoatFactor(),clearcoatRoughnessFactor:r.getClearcoatRoughnessFactor()};if(r.getClearcoatTexture()){const t=r.getClearcoatTexture(),s=r.getClearcoatTextureInfo();i.clearcoatTexture=e.createTextureInfoDef(t,s)}if(r.getClearcoatRoughnessTexture()){const t=r.getClearcoatRoughnessTexture(),s=r.getClearcoatRoughnessTextureInfo();i.clearcoatRoughnessTexture=e.createTextureInfoDef(t,s)}if(r.getClearcoatNormalTexture()){const t=r.getClearcoatNormalTexture(),s=r.getClearcoatNormalTextureInfo();i.clearcoatNormalTexture=e.createTextureInfoDef(t,s),1!==r.getClearcoatNormalScale()&&(i.clearcoatNormalTexture.scale=r.getClearcoatNormalScale())}}}),this}}le.EXTENSION_NAME=he;class pe extends e{constructor(...e){super(...e),this.propertyType="IOR",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_ior",this._ior=0}copy(e,t=s){return super.copy(e,t),this._ior=e._ior,this}getIOR(){return this._ior}setIOR(e){return this._ior=e,this}}pe.EXTENSION_NAME="KHR_materials_ior";const fe="KHR_materials_ior";class xe extends o{constructor(...e){super(...e),this.extensionName=fe}createIOR(){return new pe(this.doc.getGraph(),this)}read(e){return(e.jsonDoc.json.materials||[]).forEach((t,s)=>{if(t.extensions&&t.extensions[fe]){const r=this.createIOR();e.materials[s].setExtension(fe,r);const o=t.extensions[fe];void 0!==o.ior&&r.setIOR(o.ior)}}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(fe);if(r){const o=e.materialIndexMap.get(s),n=t.json.materials[o];n.extensions=n.extensions||{},n.extensions[fe]={ior:r.getIOR()}}}),this}}xe.EXTENSION_NAME=fe;const{R:de,G:Te,B:ge,A:me}=m;class _e extends e{constructor(...e){super(...e),this.propertyType="PBRSpecularGlossiness",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_pbrSpecularGlossiness",this._diffuseFactor=[1,1,1,1],this._specularFactor=[1,1,1],this._glossinessFactor=1,this.diffuseTexture=null,this.diffuseTextureInfo=this.graph.link("diffuseTextureInfo",this,new T(this.graph)),this.specularGlossinessTexture=null,this.specularGlossinessTextureInfo=this.graph.link("specularGlossinessTextureInfo",this,new T(this.graph))}copy(e,t=s){return super.copy(e,t),this._diffuseFactor=e._diffuseFactor,this._specularFactor=e._specularFactor,this._glossinessFactor=e._glossinessFactor,this.setDiffuseTexture(e.diffuseTexture?t(e.diffuseTexture.getChild()):null),this.diffuseTextureInfo.getChild().copy(t(e.diffuseTextureInfo.getChild()),t),this.setSpecularGlossinessTexture(e.specularGlossinessTexture?t(e.specularGlossinessTexture.getChild()):null),this.specularGlossinessTextureInfo.getChild().copy(t(e.specularGlossinessTextureInfo.getChild()),t),this}dispose(){this.diffuseTextureInfo.getChild().dispose(),this.specularGlossinessTextureInfo.getChild().dispose(),super.dispose()}getDiffuseFactor(){return this._diffuseFactor}setDiffuseFactor(e){return this._diffuseFactor=e,this}getDiffuseHex(){return x.factorToHex(this._diffuseFactor)}setDiffuseHex(e){return x.hexToFactor(e,this._diffuseFactor),this}getDiffuseTexture(){return this.diffuseTexture?this.diffuseTexture.getChild():null}getDiffuseTextureInfo(){return this.diffuseTexture?this.diffuseTextureInfo.getChild():null}setDiffuseTexture(e){return this.diffuseTexture=this.graph.linkTexture("diffuseTexture",de|Te|ge|me,this,e),this}getSpecularFactor(){return this._specularFactor}setSpecularFactor(e){return this._specularFactor=e,this}getGlossinessFactor(){return this._glossinessFactor}setGlossinessFactor(e){return this._glossinessFactor=e,this}getSpecularGlossinessTexture(){return this.specularGlossinessTexture?this.specularGlossinessTexture.getChild():null}getSpecularGlossinessTextureInfo(){return this.specularGlossinessTexture?this.specularGlossinessTextureInfo.getChild():null}setSpecularGlossinessTexture(e){return this.specularGlossinessTexture=this.graph.linkTexture("specularGlossinessTexture",de|Te|ge|me,this,e),this}}_e.EXTENSION_NAME="KHR_materials_pbrSpecularGlossiness",C([g],_e.prototype,"diffuseTexture",void 0),C([g],_e.prototype,"diffuseTextureInfo",void 0),C([g],_e.prototype,"specularGlossinessTexture",void 0),C([g],_e.prototype,"specularGlossinessTextureInfo",void 0);const Ee="KHR_materials_pbrSpecularGlossiness";class Ce extends o{constructor(...e){super(...e),this.extensionName=Ee}createPBRSpecularGlossiness(){return new _e(this.doc.getGraph(),this)}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((t,r)=>{if(t.extensions&&t.extensions[Ee]){const o=this.createPBRSpecularGlossiness();e.materials[r].setExtension(Ee,o);const n=t.extensions[Ee];if(void 0!==n.diffuseFactor&&o.setDiffuseFactor(n.diffuseFactor),void 0!==n.specularFactor&&o.setSpecularFactor(n.specularFactor),void 0!==n.glossinessFactor&&o.setGlossinessFactor(n.glossinessFactor),void 0!==n.diffuseTexture){const t=n.diffuseTexture;o.setDiffuseTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getDiffuseTextureInfo(),t)}if(void 0!==n.specularGlossinessTexture){const t=n.specularGlossinessTexture;o.setSpecularGlossinessTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getSpecularGlossinessTextureInfo(),t)}}}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Ee);if(r){const o=e.materialIndexMap.get(s),n=t.json.materials[o];n.extensions=n.extensions||{};const i=n.extensions[Ee]={diffuseFactor:r.getDiffuseFactor(),specularFactor:r.getSpecularFactor(),glossinessFactor:r.getGlossinessFactor()};if(r.getDiffuseTexture()){const t=r.getDiffuseTexture(),s=r.getDiffuseTextureInfo();i.diffuseTexture=e.createTextureInfoDef(t,s)}if(r.getSpecularGlossinessTexture()){const t=r.getSpecularGlossinessTexture(),s=r.getSpecularGlossinessTextureInfo();i.specularGlossinessTexture=e.createTextureInfoDef(t,s)}}}),this}}Ce.EXTENSION_NAME=Ee;const{R:Ie,G:Ne,B:ye,A:Re}=m;class Ae extends e{constructor(...e){super(...e),this.propertyType="Sheen",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_sheen",this._sheenColorFactor=[0,0,0],this._sheenRoughnessFactor=0,this.sheenColorTexture=null,this.sheenColorTextureInfo=this.graph.link("sheenColorTextureInfo",this,new T(this.graph)),this.sheenRoughnessTexture=null,this.sheenRoughnessTextureInfo=this.graph.link("sheenRoughnessTextureInfo",this,new T(this.graph))}copy(e,t=s){return super.copy(e,t),this._sheenColorFactor=e._sheenColorFactor,this._sheenRoughnessFactor=e._sheenRoughnessFactor,this.setSheenColorTexture(e.sheenColorTexture?t(e.sheenColorTexture.getChild()):null),this.sheenColorTextureInfo.getChild().copy(t(e.sheenColorTextureInfo.getChild()),t),this.setSheenRoughnessTexture(e.sheenRoughnessTexture?t(e.sheenRoughnessTexture.getChild()):null),this.sheenRoughnessTextureInfo.getChild().copy(t(e.sheenRoughnessTextureInfo.getChild()),t),this}dispose(){this.sheenColorTextureInfo.getChild().dispose(),this.sheenRoughnessTextureInfo.getChild().dispose(),super.dispose()}getSheenColorFactor(){return this._sheenColorFactor}getSheenColorHex(){return x.factorToHex(this._sheenColorFactor)}setSheenColorFactor(e){return this._sheenColorFactor=e,this}setSheenColorHex(e){return x.hexToFactor(e,this._sheenColorFactor),this}getSheenColorTexture(){return this.sheenColorTexture?this.sheenColorTexture.getChild():null}getSheenColorTextureInfo(){return this.sheenColorTexture?this.sheenColorTextureInfo.getChild():null}setSheenColorTexture(e){return this.sheenColorTexture=this.graph.linkTexture("sheenColorTexture",Ie|Ne|ye,this,e),this}getSheenRoughnessFactor(){return this._sheenRoughnessFactor}setSheenRoughnessFactor(e){return this._sheenRoughnessFactor=e,this}getSheenRoughnessTexture(){return this.sheenRoughnessTexture?this.sheenRoughnessTexture.getChild():null}getSheenRoughnessTextureInfo(){return this.sheenRoughnessTexture?this.sheenRoughnessTextureInfo.getChild():null}setSheenRoughnessTexture(e){return this.sheenRoughnessTexture=this.graph.linkTexture("sheenRoughnessTexture",Re,this,e),this}}Ae.EXTENSION_NAME="KHR_materials_sheen",C([g],Ae.prototype,"sheenColorTexture",void 0),C([g],Ae.prototype,"sheenColorTextureInfo",void 0),C([g],Ae.prototype,"sheenRoughnessTexture",void 0),C([g],Ae.prototype,"sheenRoughnessTextureInfo",void 0);const Se="KHR_materials_sheen";class Fe extends o{constructor(...e){super(...e),this.extensionName=Se}createSheen(){return new Ae(this.doc.getGraph(),this)}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((t,r)=>{if(t.extensions&&t.extensions[Se]){const o=this.createSheen();e.materials[r].setExtension(Se,o);const n=t.extensions[Se];if(void 0!==n.sheenColorFactor&&o.setSheenColorFactor(n.sheenColorFactor),void 0!==n.sheenRoughnessFactor&&o.setSheenRoughnessFactor(n.sheenRoughnessFactor),void 0!==n.sheenColorTexture){const t=n.sheenColorTexture;o.setSheenColorTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getSheenColorTextureInfo(),t)}if(void 0!==n.sheenRoughnessTexture){const t=n.sheenRoughnessTexture;o.setSheenRoughnessTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getSheenRoughnessTextureInfo(),t)}}}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Se);if(r){const o=e.materialIndexMap.get(s),n=t.json.materials[o];n.extensions=n.extensions||{};const i=n.extensions[Se]={sheenColorFactor:r.getSheenColorFactor(),sheenRoughnessFactor:r.getSheenRoughnessFactor()};if(r.getSheenColorTexture()){const t=r.getSheenColorTexture(),s=r.getSheenColorTextureInfo();i.sheenColorTexture=e.createTextureInfoDef(t,s)}if(r.getSheenRoughnessTexture()){const t=r.getSheenRoughnessTexture(),s=r.getSheenRoughnessTextureInfo();i.sheenRoughnessTexture=e.createTextureInfoDef(t,s)}}}),this}}Fe.EXTENSION_NAME=Se;const{R:we,G:Me,B:Oe,A:De}=m;class be extends e{constructor(...e){super(...e),this.propertyType="Specular",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_specular",this._specularFactor=1,this._specularColorFactor=[1,1,1],this.specularTexture=null,this.specularTextureInfo=this.graph.link("specularTextureInfo",this,new T(this.graph)),this.specularColorTexture=null,this.specularColorTextureInfo=this.graph.link("specularColorTextureInfo",this,new T(this.graph))}copy(e,t=s){return super.copy(e,t),this._specularFactor=e._specularFactor,this._specularColorFactor=e._specularColorFactor,this.setSpecularTexture(e.specularTexture?t(e.specularTexture.getChild()):null),this.specularTextureInfo.getChild().copy(t(e.specularTextureInfo.getChild()),t),this.setSpecularColorTexture(e.specularColorTexture?t(e.specularColorTexture.getChild()):null),this.specularColorTextureInfo.getChild().copy(t(e.specularColorTextureInfo.getChild()),t),this}dispose(){this.specularTextureInfo.getChild().dispose(),super.dispose()}getSpecularFactor(){return this._specularFactor}setSpecularFactor(e){return this._specularFactor=e,this}getSpecularColorFactor(){return this._specularColorFactor}setSpecularColorFactor(e){return this._specularColorFactor=e,this}getSpecularColorHex(){return x.factorToHex(this._specularColorFactor)}setSpecularColorHex(e){return x.hexToFactor(e,this._specularColorFactor),this}getSpecularTexture(){return this.specularTexture?this.specularTexture.getChild():null}getSpecularTextureInfo(){return this.specularTexture?this.specularTextureInfo.getChild():null}setSpecularTexture(e){return this.specularTexture=this.graph.linkTexture("specularTexture",De,this,e),this}getSpecularColorTexture(){return this.specularColorTexture?this.specularColorTexture.getChild():null}getSpecularColorTextureInfo(){return this.specularColorTexture?this.specularColorTextureInfo.getChild():null}setSpecularColorTexture(e){return this.specularColorTexture=this.graph.linkTexture("specularColorTexture",we|Me|Oe,this,e),this}}be.EXTENSION_NAME="KHR_materials_specular",C([g],be.prototype,"specularTexture",void 0),C([g],be.prototype,"specularTextureInfo",void 0),C([g],be.prototype,"specularColorTexture",void 0),C([g],be.prototype,"specularColorTextureInfo",void 0);const ve="KHR_materials_specular";class Ge extends o{constructor(...e){super(...e),this.extensionName=ve}createSpecular(){return new be(this.doc.getGraph(),this)}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((t,r)=>{if(t.extensions&&t.extensions[ve]){const o=this.createSpecular();e.materials[r].setExtension(ve,o);const n=t.extensions[ve];if(void 0!==n.specularFactor&&o.setSpecularFactor(n.specularFactor),void 0!==n.specularColorFactor&&o.setSpecularColorFactor(n.specularColorFactor),void 0!==n.specularTexture){const t=n.specularTexture;o.setSpecularTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getSpecularTextureInfo(),t)}if(void 0!==n.specularColorTexture){const t=n.specularColorTexture;o.setSpecularColorTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getSpecularColorTextureInfo(),t)}}}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(ve);if(r){const o=e.materialIndexMap.get(s),n=t.json.materials[o];n.extensions=n.extensions||{};const i=n.extensions[ve]={};if(1!==r.getSpecularFactor()&&(i.specularFactor=r.getSpecularFactor()),d.eq(r.getSpecularColorFactor(),[1,1,1])||(i.specularColorFactor=r.getSpecularColorFactor()),r.getSpecularTexture()){const t=r.getSpecularTexture(),s=r.getSpecularTextureInfo();i.specularTexture=e.createTextureInfoDef(t,s)}if(r.getSpecularColorTexture()){const t=r.getSpecularColorTexture(),s=r.getSpecularColorTextureInfo();i.specularColorTexture=e.createTextureInfoDef(t,s)}}}),this}}Ge.EXTENSION_NAME=ve;const{R:je}=m;class Be extends e{constructor(...e){super(...e),this.propertyType="Transmission",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_transmission",this._transmissionFactor=0,this.transmissionTexture=null,this.transmissionTextureInfo=this.graph.link("transmissionTextureInfo",this,new T(this.graph))}copy(e,t=s){return super.copy(e,t),this._transmissionFactor=e._transmissionFactor,this.setTransmissionTexture(e.transmissionTexture?t(e.transmissionTexture.getChild()):null),this.transmissionTextureInfo.getChild().copy(t(e.transmissionTextureInfo.getChild()),t),this}dispose(){this.transmissionTextureInfo.getChild().dispose(),super.dispose()}getTransmissionFactor(){return this._transmissionFactor}setTransmissionFactor(e){return this._transmissionFactor=e,this}getTransmissionTexture(){return this.transmissionTexture?this.transmissionTexture.getChild():null}getTransmissionTextureInfo(){return this.transmissionTexture?this.transmissionTextureInfo.getChild():null}setTransmissionTexture(e){return this.transmissionTexture=this.graph.linkTexture("transmissionTexture",je,this,e),this}}Be.EXTENSION_NAME="KHR_materials_transmission",C([g],Be.prototype,"transmissionTexture",void 0),C([g],Be.prototype,"transmissionTextureInfo",void 0);const Le="KHR_materials_transmission";class ke extends o{constructor(...e){super(...e),this.extensionName=Le}createTransmission(){return new Be(this.doc.getGraph(),this)}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((t,r)=>{if(t.extensions&&t.extensions[Le]){const o=this.createTransmission();e.materials[r].setExtension(Le,o);const n=t.extensions[Le];if(void 0!==n.transmissionFactor&&o.setTransmissionFactor(n.transmissionFactor),void 0!==n.transmissionTexture){const t=n.transmissionTexture;o.setTransmissionTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getTransmissionTextureInfo(),t)}}}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Le);if(r){const o=e.materialIndexMap.get(s),n=t.json.materials[o];n.extensions=n.extensions||{};const i=n.extensions[Le]={transmissionFactor:r.getTransmissionFactor()};if(r.getTransmissionTexture()){const t=r.getTransmissionTexture(),s=r.getTransmissionTextureInfo();i.transmissionTexture=e.createTextureInfoDef(t,s)}}}),this}}ke.EXTENSION_NAME=Le;class Ue extends e{constructor(...e){super(...e),this.propertyType="Unlit",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_unlit"}}Ue.EXTENSION_NAME="KHR_materials_unlit";const He="KHR_materials_unlit";class Ve extends o{constructor(...e){super(...e),this.extensionName=He}createUnlit(){return new Ue(this.doc.getGraph(),this)}read(e){return(e.jsonDoc.json.materials||[]).forEach((t,s)=>{t.extensions&&t.extensions[He]&&e.materials[s].setExtension(He,this.createUnlit())}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{if(s.getExtension(He)){const r=e.materialIndexMap.get(s),o=t.json.materials[r];o.extensions=o.extensions||{},o.extensions[He]={}}}),this}}Ve.EXTENSION_NAME=He;class Pe extends e{constructor(...e){super(...e),this.propertyType="Mapping",this.parentTypes=["MappingList"],this.extensionName="KHR_materials_variants",this.material=null,this.variants=[]}copy(e,t=s){return super.copy(e,t),this.setMaterial(e.material?t(e.material.getChild()):null),this.clearGraphChildList(this.variants),e.variants.forEach(e=>this.addVariant(t(e.getChild()))),this}getMaterial(){return this.material?this.material.getChild():null}setMaterial(e){return this.material=this.graph.link("material",this,e),this}addVariant(e){const t=this.graph.link("variant",this,e);return this.addGraphChild(this.variants,t)}removeVariant(e){return this.removeGraphChild(this.variants,e)}listVariants(){return this.variants.map(e=>e.getChild())}}Pe.EXTENSION_NAME="KHR_materials_variants",C([g],Pe.prototype,"material",void 0),C([r],Pe.prototype,"variants",void 0);class Xe extends e{constructor(...e){super(...e),this.propertyType="MappingList",this.parentTypes=[t.PRIMITIVE],this.extensionName="KHR_materials_variants",this.mappings=[]}copy(e,t=s){return super.copy(e,t),this.clearGraphChildList(this.mappings),e.mappings.forEach(e=>this.addMapping(t(e.getChild()))),this}addMapping(e){const t=this.graph.link("mapping",this,e);return this.addGraphChild(this.mappings,t)}removeMapping(e){return this.removeGraphChild(this.mappings,e)}listMappings(){return this.mappings.map(e=>e.getChild())}}Xe.EXTENSION_NAME="KHR_materials_variants",C([r],Xe.prototype,"mappings",void 0);class Ke extends e{constructor(...e){super(...e),this.propertyType="Variant",this.parentTypes=[t.ROOT,"MappingList"],this.extensionName="KHR_materials_variants"}}Ke.EXTENSION_NAME="KHR_materials_variants";const ze="KHR_materials_variants";class qe extends o{constructor(...e){super(...e),this.extensionName=ze}createMappingList(){return new Xe(this.doc.getGraph(),this)}createVariant(e=""){return new Ke(this.doc.getGraph(),this).setName(e)}createMapping(){return new Pe(this.doc.getGraph(),this)}listVariants(){return Array.from(this.properties).filter(e=>e instanceof Ke)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[ze])return this;const s=(t.json.extensions[ze].variants||[]).map(e=>this.createVariant().setName(e.name||""));return(t.json.meshes||[]).forEach((t,r)=>{const o=e.meshes[r];(t.primitives||[]).forEach((t,r)=>{if(!t.extensions||!t.extensions[ze])return;const n=this.createMappingList(),i=t.extensions[ze];for(const t of i.mappings){const r=this.createMapping();void 0!==t.material&&r.setMaterial(e.materials[t.material]);for(const e of t.variants||[])r.addVariant(s[e]);n.addMapping(r)}o.listPrimitives()[r].setExtension(ze,n)})}),this}write(e){const t=e.jsonDoc,s=this.listVariants();if(!s.length)return this;const r=[],o=new Map;for(const t of s)o.set(t,r.length),r.push(e.createPropertyDef(t));for(const t of this.doc.getRoot().listMeshes()){const s=e.meshIndexMap.get(t);t.listPrimitives().forEach((t,r)=>{const n=t.getExtension(ze);if(!n)return;const i=e.jsonDoc.json.meshes[s].primitives[r],a=n.listMappings().map(t=>{const s=e.createPropertyDef(t),r=t.getMaterial();return r&&(s.material=e.materialIndexMap.get(r)),s.variants=t.listVariants().map(e=>o.get(e)),s});i.extensions=i.extensions||{},i.extensions[ze]={mappings:a}})}return t.json.extensions=t.json.extensions||{},t.json.extensions[ze]={variants:r},this}}qe.EXTENSION_NAME=ze;const{G:$e}=m;class Ye extends e{constructor(...e){super(...e),this.propertyType="Transmission",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_volume",this._thicknessFactor=0,this._attenuationDistance=Infinity,this._attenuationColor=[1,1,1],this.thicknessTexture=null,this.thicknessTextureInfo=this.graph.link("thicknessTextureInfo",this,new T(this.graph))}copy(e,t=s){return super.copy(e,t),this._thicknessFactor=e._thicknessFactor,this._attenuationDistance=e._attenuationDistance,this._attenuationColor=[...e._attenuationColor],this.setThicknessTexture(e.thicknessTexture?t(e.thicknessTexture.getChild()):null),this.thicknessTextureInfo.getChild().copy(t(e.thicknessTextureInfo.getChild()),t),this}dispose(){this.thicknessTextureInfo.getChild().dispose(),super.dispose()}getThicknessFactor(){return this._thicknessFactor}setThicknessFactor(e){return this._thicknessFactor=e,this}getThicknessTexture(){return this.thicknessTexture?this.thicknessTexture.getChild():null}getThicknessTextureInfo(){return this.thicknessTexture?this.thicknessTextureInfo.getChild():null}setThicknessTexture(e){return this.thicknessTexture=this.graph.linkTexture("thicknessTexture",$e,this,e),this}getAttenuationDistance(){return this._attenuationDistance}setAttenuationDistance(e){return this._attenuationDistance=e,this}getAttenuationColor(){return this._attenuationColor}setAttenuationColor(e){return this._attenuationColor=e,this}getAttenuationColorHex(){return x.factorToHex(this._attenuationColor)}setAttenuationColorHex(e){return x.hexToFactor(e,this._attenuationColor),this}}Ye.EXTENSION_NAME="KHR_materials_volume",C([g],Ye.prototype,"thicknessTexture",void 0),C([g],Ye.prototype,"thicknessTextureInfo",void 0);const Qe="KHR_materials_volume";class We extends o{constructor(...e){super(...e),this.extensionName=Qe}createVolume(){return new Ye(this.doc.getGraph(),this)}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((t,r)=>{if(t.extensions&&t.extensions[Qe]){const o=this.createVolume();e.materials[r].setExtension(Qe,o);const n=t.extensions[Qe];if(void 0!==n.thicknessFactor&&o.setThicknessFactor(n.thicknessFactor),void 0!==n.attenuationDistance&&o.setAttenuationDistance(n.attenuationDistance),void 0!==n.attenuationColor&&o.setAttenuationColor(n.attenuationColor),void 0!==n.thicknessTexture){const t=n.thicknessTexture;o.setThicknessTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getThicknessTextureInfo(),t)}}}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Qe);if(r){const o=e.materialIndexMap.get(s),n=t.json.materials[o];n.extensions=n.extensions||{};const i=n.extensions[Qe]={};if(r.getThicknessFactor()>0&&(i.thicknessFactor=r.getThicknessFactor()),Number.isFinite(r.getAttenuationDistance())&&(i.attenuationDistance=r.getAttenuationDistance()),d.eq(r.getAttenuationColor(),[1,1,1])||(i.attenuationColor=r.getAttenuationColor()),r.getThicknessTexture()){const t=r.getThicknessTexture(),s=r.getThicknessTextureInfo();i.thicknessTexture=e.createTextureInfoDef(t,s)}}}),this}}We.EXTENSION_NAME=Qe;const Je="KHR_mesh_quantization";class Ze extends o{constructor(...e){super(...e),this.extensionName=Je}read(e){return this}write(e){return this}}Ze.EXTENSION_NAME=Je;const et="KHR_texture_basisu";class tt{getSize(e){const t=_(new Uint8Array(e));return[t.pixelWidth,t.pixelHeight]}getChannels(e){const t=_(new Uint8Array(e)).dataFormatDescriptor[0];if(t.colorModel===E.ETC1S)return 2===t.samples.length&&15==(15&t.samples[1].channelID)?4:3;if(t.colorModel===E.UASTC)return 3==(15&t.samples[0].channelID)?4:3;throw new Error(`Unexpected KTX2 colorModel, "${t.colorModel}".`)}getGPUByteLength(e){const t=_(new Uint8Array(e)),s=this.getChannels(e)>3;let r=0;for(let e=0;e<t.levels.length;e++){const o=t.levels[e];r+=o.uncompressedByteLength?o.uncompressedByteLength:Math.max(1,Math.floor(t.pixelWidth/Math.pow(2,e)))/4*(Math.max(1,Math.floor(t.pixelHeight/Math.pow(2,e)))/4)*(s?16:8)}return r}}class st extends o{constructor(...e){super(...e),this.extensionName=et,this.prereadTypes=[t.TEXTURE]}static register(){p.registerFormat("image/ktx2",new tt)}preread(e){return e.jsonDoc.json.textures.forEach(e=>{e.extensions&&e.extensions[et]&&(e.source=e.extensions[et].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listTextures().forEach(s=>{if("image/ktx2"===s.getMimeType()){const r=e.imageIndexMap.get(s);t.json.textures.forEach(e=>{e.source===r&&(e.extensions=e.extensions||{},e.extensions[et]={source:e.source},delete e.source)})}}),this}}st.EXTENSION_NAME=et;class rt extends e{constructor(...e){super(...e),this.propertyType="Transform",this.parentTypes=[t.TEXTURE_INFO],this.extensionName="KHR_texture_transform",this._offset=[0,0],this._rotation=0,this._scale=[1,1],this._texCoord=null}copy(e,t=s){return super.copy(e,t),this._offset=e._offset,this._rotation=e._rotation,this._scale=e._scale,this._texCoord=e._texCoord,this}getOffset(){return this._offset}setOffset(e){return this._offset=e,this}getRotation(){return this._rotation}setRotation(e){return this._rotation=e,this}getScale(){return this._scale}setScale(e){return this._scale=e,this}getTexCoord(){return this._texCoord}setTexCoord(e){return this._texCoord=e,this}}rt.EXTENSION_NAME="KHR_texture_transform";const ot="KHR_texture_transform";class nt extends o{constructor(...e){super(...e),this.extensionName=ot}createTransform(){return new rt(this.doc.getGraph(),this)}read(e){for(const[t,s]of Array.from(e.textureInfos.entries())){if(!s.extensions||!s.extensions[ot])continue;const e=this.createTransform(),r=s.extensions[ot];void 0!==r.offset&&e.setOffset(r.offset),void 0!==r.rotation&&e.setRotation(r.rotation),void 0!==r.scale&&e.setScale(r.scale),void 0!==r.texCoord&&e.setTexCoord(r.texCoord),t.setExtension(ot,e)}return this}write(e){const t=Array.from(e.textureInfoDefMap.entries());for(const[e,s]of t){const t=e.getExtension(ot);if(!t)continue;s.extensions=s.extensions||{};const r={},o=d.eq;o(t.getOffset(),[0,0])||(r.offset=t.getOffset()),0!==t.getRotation()&&(r.rotation=t.getRotation()),o(t.getScale(),[1,1])||(r.scale=t.getScale()),null!=t.getTexCoord()&&(r.texCoord=t.getTexCoord()),s.extensions[ot]=r}return this}}nt.EXTENSION_NAME=ot;const it=[te,ne,le,xe,Ce,Ge,Fe,ke,Ve,qe,We,Ze,st,nt],at=[y,G,L,...it];export{at as ALL_EXTENSIONS,ue as Clearcoat,te as DracoMeshCompression,pe as IOR,I as InstancedMesh,it as KHRONOS_EXTENSIONS,re as Light,ne as LightsPunctual,Pe as Mapping,Xe as MappingList,le as MaterialsClearcoat,xe as MaterialsIOR,Ce as MaterialsPBRSpecularGlossiness,Fe as MaterialsSheen,Ge as MaterialsSpecular,ke as MaterialsTransmission,Ve as MaterialsUnlit,qe as MaterialsVariants,We as MaterialsVolume,y as MeshGPUInstancing,Ze as MeshQuantization,G as MeshoptCompression,_e as PBRSpecularGlossiness,Ae as Sheen,be as Specular,st as TextureBasisu,nt as TextureTransform,L as TextureWebP,rt as Transform,Be as Transmission,Ue as Unlit,Ke as Variant,Ye as Volume};
//# sourceMappingURL=extensions.modern.js.map
